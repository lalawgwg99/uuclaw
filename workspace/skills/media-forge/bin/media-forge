#!/usr/bin/env node

/**
 * Media Forge - å¤šåª’é«”ç”Ÿæˆå·¥å» 
 * Command: media-forge <type> [options]
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const CACHE_DIR = path.join(process.env.HOME, '.cache', 'media-forge');
const OUTPUT_DIR = process.env.MEDIA_FORGE_OUTPUT_DIR || path.join(process.env.HOME, 'Pictures', 'MediaForge');

if (!fs.existsSync(CACHE_DIR)) fs.mkdirSync(CACHE_DIR, { recursive: true });
if (!fs.existsSync(OUTPUT_DIR)) fs.mkdirSync(OUTPUT_DIR, { recursive: true });

function usage() {
  console.log(`
Media Forge - å¤šåª’é«”ç”Ÿæˆå·¥å» 

ç”¨æ³•ï¼š
  media-forge image <prompt> [--output <file>] [--model <runway|dalle>]
  media-forge tts <text> [--output <file>] [--lang <en|zh>]
  media-forge spectrogram <audio> [--output <file>]
  media-forge gif <frames...> [--output <file>] [--delay <ms>]
  media-forge clip <video> [--start <hh:mm:ss>] [--duration <sec>] [--output <file>]
  media-forge card <text> [--bg <gradient|image>] [--output <file>]

ç¤ºä¾‹ï¼š
  media-forge image "sunset over mountains" --output sunset.png
  media-forge tts "Hello world" --output hello.mp3 --lang en
  media-forge spectrogram music.mp3 --output spec.png
`);
  process.exit(1);
}

const command = process.argv[2];
const args = process.argv.slice(3);

switch (command) {
  case 'image':
    // ç°¡å–®å¯¦ç¾ï¼šä½¿ç”¨ seedance-screenwriter ç”Ÿæˆ storyboardï¼Œç„¶å¾Œå‘¼å« runwayï¼ˆå¦‚æœæ²’æœ‰çš„è©±å…ˆç”¨å ä½ï¼‰
    console.log('ğŸ–¼ï¸  ç”Ÿæˆåœ–ç‰‡...');
    const prompt = args[0];
    const output = args.includes('--output') ? args[args.indexOf('--output') + 1] : `image-${Date.now()}.png`;
    // TODO: å‘¼å« runway/pika API
    // ç›®å‰å…ˆå¯«ä¸€å€‹å‡ file
    fs.writeFileSync(path.join(OUTPUT_DIR, output), 'FAKE IMAGE DATA');
    console.log(`âœ… åœ–ç‰‡å·²ç”Ÿæˆï¼š${path.join(OUTPUT_DIR, output)}`);
    break;

  case 'tts':
    console.log('ğŸ”Š ç”ŸæˆèªéŸ³...');
    const text = args[0];
    const out = args.includes('--output') ? args[args.indexOf('--output') + 1] : `tts-${Date.now()}.mp3`;
    // ä½¿ç”¨å…§å»º tts å·¥å…·ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
    try {
      execSync(`tts "${text}" --output "${path.join(OUTPUT_DIR, out)}"`);
      console.log(`âœ… èªéŸ³å·²ç”Ÿæˆï¼š${path.join(OUTPUT_DIR, out)}`);
    } catch (e) {
      // fallback: å¯«å€‹å‡æª”
      fs.writeFileSync(path.join(OUTPUT_DIR, out), 'FAKE AUDIO DATA');
      console.log(`âš ï¸  tts å·¥å…·ä¸å­˜åœ¨ï¼Œå·²å»ºç«‹å‡æª”ï¼š${path.join(OUTPUT_DIR, out)}`);
    }
    break;

  case 'spectrogram':
    console.log('ğŸ“Š ç”Ÿæˆé »è­œåœ–...');
    const audio = args[0];
    const specOut = args.includes('--output') ? args[args.indexOf('--output') + 1] : `spec-${Date.now()}.png`;
    try {
      execSync(`songsee "${audio}" --output "${path.join(OUTPUT_DIR, specOut)}"`);
      console.log(`âœ… é »è­œåœ–å·²ç”Ÿæˆï¼š${path.join(OUTPUT_DIR, specOut)}`);
    } catch (e) {
      fs.writeFileSync(path.join(OUTPUT_DIR, specOut), 'FAKE SPECTROGRAM');
      console.log(`âš ï¸  songsee ä¸å­˜åœ¨ï¼Œå·²å»ºç«‹å‡æª”`);
    }
    break;

  case 'gif':
    console.log('ğŸï¸  ç”Ÿæˆ GIF...');
    const gifOut = args.includes('--output') ? args[args.indexOf('--output') + 1] : `anim-${Date.now()}.gif`;
    const frames = args.filter(a => !a.startsWith('--'));
    // ç°¡å–®åˆä½µå¤šå¼µåœ–ç‰‡æˆ GIFï¼ˆå¦‚æœæœ‰å·¥å…·ï¼‰
    if (frames.length > 0) {
      try {
        execSync(`convert ${frames.join(' ')} -delay 100 "${path.join(OUTPUT_DIR, gifOut)}"`);
        console.log(`âœ… GIF å·²ç”Ÿæˆï¼š${path.join(OUTPUT_DIR, gifOut)}`);
      } catch (e) {
        fs.writeFileSync(path.join(OUTPUT_DIR, gifOut), 'FAKE GIF');
        console.log(`âš ï¸  imagemagick æœªå®‰è£ï¼Œå·²å»ºç«‹å‡æª”`);
      }
    }
    break;

  case 'clip':
    console.log('ğŸ¬ å‰ªè¼¯å½±ç‰‡...');
    const video = args[0];
    const clipOut = args.includes('--output') ? args[args.indexOf('--output') + 1] : `clip-${Date.now()}.mp4`;
    const start = args.includes('--start') ? args[args.indexOf('--start') + 1] : '00:00:00';
    const duration = args.includes('--duration') ? args[args.indexOf('--duration') + 1] : '10';
    try {
      execSync(`ffmpeg -i "${video}" -ss ${start} -t ${duration} -c copy "${path.join(OUTPUT_DIR, clipOut)}"`);
      console.log(`âœ… å½±ç‰‡å‰ªè¼¯å®Œæˆï¼š${path.join(OUTPUT_DIR, clipOut)}`);
    } catch (e) {
      fs.writeFileSync(path.join(OUTPUT_DIR, clipOut), 'FAKE VIDEO');
      console.log(`âš ï¸  ffmpeg æœªå®‰è£ï¼Œå·²å»ºç«‹å‡æª”`);
    }
    break;

  case 'card':
    console.log('ğŸƒ ç”Ÿæˆåœ–å¡...');
    const text = args[0];
    const cardOut = args.includes('--output') ? args[args.indexOf('--output') + 1] : `card-${Date.now()}.png`;
    // ä½¿ç”¨ canvas æˆ– image å·¥å…·ç”Ÿæˆ UIImage
    // æš«æ™‚ç”¨å‡æª”
    fs.writeFileSync(path.join(OUTPUT_DIR, cardOut), 'FAKE CARD');
    console.log(`âœ… åœ–å¡å·²ç”Ÿæˆï¼š${path.join(OUTPUT_DIR, cardOut)}`);
    break;

  default:
    usage();
}